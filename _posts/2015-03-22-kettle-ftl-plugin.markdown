---
layout: post
title:  "Using Freemarker in Kettle"
date:   2015-03-22 12:24:09
categories: kettle freemarker 
---
Hand coding generation of structured or semi-structured data is a tedious and error-prone endeavor.  Fortunately, there are template engines available to take care it; allowing us to focus on what we want the data to look like rather than how to make it look that way.

[Freemarker][freemarker] is one such engine for Java.  It has support for conditional logic and loops as well as variable substition.

With the [FTL Plugin][plugin] for [Pentaho Data Integration (PDI or Kettle)][pdi], you can use Freemarker to apply a template to the data generated by a transformation.

As an example, we can pretty easily generate a html page with data taken from [Mongo][mongo].

We'll start by spinning up a [Mongo Docker Container and filling it with the enron email dataset][docker-mongo]. (If you already have access to some mongo data, you may want to skip this step and then tweak the html and mongo query to suit your needs.)

Now start Kettle and select "Help" -> "Marketplace".

Type "ftl" (without the quotes) into the search bar.

Install the plugin and restart Spoon. (This guide was developed using version 0.1.3.1.)

Once that's done, we can start Kettle and create a new transformation.  First, drag a Mongo Input step onto the canvas.  Configure it with the IP address of the container:
{% highlight bash %}
{% raw %}
docker inspect -f="{{.NetworkSettings.IPAddress}}" my-mongo-instance
{% endraw %}
{% endhighlight %}

Select the "Input options" tab.

Click "Get DBs" and then select the enron_mail database.

Click "Get collections" and then select the messages collection.

Select the "Query" tab.

Enter the following into the query field:
{% highlight json %}
{'headers.From':'michael.simmons@enron.com'}
{% endhighlight %}

Select the "Fields" tab.

Uncheck the "Output single JSON field" and click the "Get Fields".

Confirm the dialog with the number of rows you'd like to sample (100 is fine as we've filtered down to 7 emails with the query).

Drag a "FreeMarker Template" step onto the canvas and connect the Mongo step to it.

Open the configuration dialog and paste the following in:

{% highlight html %}
<#if ftlFirstRow>
<html>
  <head>
    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th, td {
        padding: 15px;
      }
    </style>
  </head>
  <body>
    <table>
      <tr><th>From</th><th>To</th><th>Subject</th></tr>
</#if>
      <tr><td>${From}</td><td>${To}</td><td>${Subject}</td>
<#if ftlLastRow>
    </table>
  </body>
</html>
</#if>
{% endhighlight %}

This will output the html header up to the table headers for the first row, then the row, then the closing tags for the last row.

Drag a "Text file output" step onto the canvas and connect the FreeMarker Template step to it.

Open the Text file output's configuration dialog, set the filename to emails and the extension to html.

Select the "Content" tab, uncheck the Header box, delete the enclosure field and set the format to "LF terminated (Unix)"

Select the "Fields" tab, perform the "Get Fields" action, delete all rows except for ftlOutput.

Run the transformation and you should now have an emails.html in your data-integration folder with a table summarizing the emails!

You can download my version of the transformation [here][ktr].

[freemarker]: http://freemarker.org/
[plugin]: https://github.com/brosander/kettle-plugins/tree/master/ftl
[pdi]: http://wiki.pentaho.com/display/BAD/Read+Data+From+MongoDB
[mongo]: https://www.mongodb.org/
[docker-mongo]: /docker/mongo/2015/03/20/docker-mongo-test-data.html
[ktr]: /attachments/ktrs/freemarker.ktr
